# Lab 4

## 练习 1: 加载应用程序并执行

* 设计实现过程

    1. `load_icode` 函数负责加载根据 ELF 信息加载应用程序到内存中，并建立好应用程序的内存空间；
    2. 在最后，需要设置进程的中断帧，这样之后就能通过 `forkrets` 来切换到正确的应用程序上下文中；
    3. 具体的设置方式是，将 `cs` 设置为 `USER_CS`，而 `ds`、`es`、`ss` 设置为 `USER_DS`，`esp` 设置为 `USTACKTOP`，`eip` 设置为 ELF 信息中程序代码的入口虚地址，并设置 `eflags` 中的 `FL_IF` 位，以在用户态程序中使能中断。

* 描述当创建一个用户态进程并加载了应用程序后，CPU 是如何让这个应用程序最终在用户态执行起来的。

    1. `load_icode` 执行完成后，应用程序被加载到当前进程中，且当前进程的中断帧保存了应用程序执行的上下文；
    2. `SYS_exec` 系统调用结束，中断返回时，`iret` 指令恢复了应用程序的上下文，使得应用程序在用户态执行起来。
